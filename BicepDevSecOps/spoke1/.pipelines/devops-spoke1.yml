trigger:
  batch: true
  branches:
    include: 
    - 'master'
  paths:
   include:
     - platform/*

name: Deploy Workload 1

variables:
  vmImageName: 'ubuntu-latest'

  azureServiceConnection: 'spoke1'
  location: 'westeurope'

  workloadSub: '<workloadSubId>'
  workloadNetworkResourceGroupName: 'spoke1-network'
  workloadResourceGroupName: 'spoke1'

  hubSub: '<hubSubId>'
  hubNetworkResourceGroupName: 'hub-network'

pool:
  vmImage: $(vmImageName)

steps:

# Deploy Virtual Network

- task: AzurePowerShell@5
  inputs:
    azureSubscription: $(azureServiceConnection)
    ScriptType: 'FilePath'
    ScriptPath: $(System.DefaultWorkingDirectory)/.pipelines/deploy.ps1
    ScriptArguments: > # Use this to avoid newline characters in multiline string
      -subscriptionId $(workloadSub)
      -resourceGroupName $(workloadNetworkResourceGroupName)
      -location $(location)
      -deployment "spoke1-network"
      -templateFile $(System.DefaultWorkingDirectory)"/platform/spoke1-network.bicep"
      -templateParameterFile $(System.DefaultWorkingDirectory)"/platform/spoke1-network-parameters.json"
    azurePowerShellVersion: 'LatestVersion'
  displayName: 'Deploy Virtual Network'

# Deploy Hub Firewall Rules

- task: AzurePowerShell@5
  inputs:
    azureSubscription: $(azureServiceConnection)
    ScriptType: 'FilePath'
    ScriptPath: $(System.DefaultWorkingDirectory)/.pipelines/deploy.ps1
    ScriptArguments: > # Use this to avoid newline characters in multiline string
      -subscriptionId $(hubSub)
      -resourceGroupName $(hubNetworkResourceGroupName)
      -location $(location)
      -deployment "spoke1-hubfirewall"
      -templateFile $(System.DefaultWorkingDirectory)"/platform/spoke1-hubfirewall.bicep"
      -templateParameterFile $(System.DefaultWorkingDirectory)"/platform/spoke1-hubfirewall-parameters.json"
    azurePowerShellVersion: 'LatestVersion'
  displayName: 'Deploy Hub Firewall Rules'

# Deploy Hub Routing

- task: AzurePowerShell@5
  inputs:
    azureSubscription: $(azureServiceConnection)
    ScriptType: 'FilePath'
    ScriptPath: $(System.DefaultWorkingDirectory)/.pipelines/deploy.ps1
    ScriptArguments: > # Use this to avoid newline characters in multiline string
      -subscriptionId $(hubSub)
      -resourceGroupName $(hubNetworkResourceGroupName)
      -location $(location)
      -deployment "spoke1-hubrouting"
      -templateFile $(System.DefaultWorkingDirectory)"/platform/spoke1-hubrouting.bicep"
      -templateParameterFile $(System.DefaultWorkingDirectory)"/platform/spoke1-hubrouting-parameters.json"
    azurePowerShellVersion: 'LatestVersion'
  displayName: 'Deploy Hub Routing'

# Deploy Hub Peering

- task: AzurePowerShell@5
  inputs:
    azureSubscription: $(azureServiceConnection)
    ScriptType: 'FilePath'
    ScriptPath: $(System.DefaultWorkingDirectory)/.pipelines/deploy.ps1
    ScriptArguments: > # Use this to avoid newline characters in multiline string
      -subscriptionId $(hubSub)
      -resourceGroupName $(hubNetworkResourceGroupName)
      -location $(location)
      -deployment "spoke1-hubpeering"
      -templateFile $(System.DefaultWorkingDirectory)"/platform/spoke1-hubpeering.bicep"
      -templateParameterFile $(System.DefaultWorkingDirectory)"/platform/spoke1-hubpeering-parameters.json"
    azurePowerShellVersion: 'LatestVersion'
  displayName: 'Deploy Hub Peering'
